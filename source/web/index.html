<script src="../game/classes/model/Util.js"></script>
<script src="../game/classes/model/Symbol.js"></script>
<script src="../game/classes/model/Neighbor.js"></script>
<script src="../game/classes/model/Position.js"></script>
<script src="../game/classes/model/Board.js"></script>
<script src="../game/classes/model/Game.js"></script>
<script src="../game/classes/view/Tile.js"></script>
<script src="../game/classes/view/Display.js"></script>
<script>

    document.addEventListener("DOMContentLoaded", function () {

        let AudioContext = window.AudioContext // Default
            || window.webkitAudioContext // Safari and old versions of Chrome
            || false;
        let context = new AudioContext();

        let c = document.createElement("canvas");

        c.setAttribute("width", window.innerWidth.toString());
        c.setAttribute("height", window.innerHeight.toString());

        document.body.style.margin = "0";
        document.body.appendChild(c);

        function initialize() {

            c.removeEventListener('click', initialize);

            let g = new Game(7, 7);
            let d = new Display(c, g);


            function gameOver() {
                c.removeEventListener('click', onClick);
                d.showGameOver();
                c.addEventListener('click', initialize);
            }

            function onClick(e) {

                let delay = 150;

                let values = d.onClick(e.x, e.y);
                if (g.movesUsed >= g.movesAvailable) {
                    gameOver();
                    return;
                }

                let neighbors = values["neighbors"];

                d.draw();

                if (AudioContext) {

                    let count = Object.keys(neighbors).length;
                    let noteLength = (500 / 8) / 1000;

                    let notes = [];

                    for (let i = 0; i < count; i++) {
                        notes.push(440 + (60 * i));
                    }

                    let duration = noteLength;

                    function play(frequency) {
                        let o = context.createOscillator();
                        let g = context.createGain();
                        o.connect(g);
                        g.connect(context.destination);
                        g.gain.exponentialRampToValueAtTime(
                            0.00001, context.currentTime + duration
                        );
                        o.frequency.value = frequency;
                        o.start();
                    }

                    for (let i = 0; i < notes.length; i++) {
                        setTimeout(function () {
                            play(notes[i]);
                        }, noteLength * i * 1000);
                    }


                    setTimeout(function () {
                        d.draw();

                        setTimeout(function () {
                            g.moveDown();
                            d.draw();

                        }, delay);
                    }, delay);
                }
            }

            c.addEventListener('click', onClick);

            d.draw();
        }

        initialize();

        (function() {
            window.addEventListener("resize", resizeThrottler, false);
            let resizeTimeout = null;
            function resizeThrottler() {
                if ( !resizeTimeout ) {
                    resizeTimeout = setTimeout(function() {
                        resizeTimeout = null;
                        debugger;
                        d.draw();
                    }, 66);
                }
            }
        }());    });


</script>
